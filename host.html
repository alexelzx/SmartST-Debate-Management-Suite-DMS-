<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SmartST DMS - Executive Host</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600&family=Inter:wght@400;600&display=swap');
        :root { --bg-color: #F4F2ED; --text-color: #1C1C1C; --border: rgba(0,0,0,0.1); --danger: #b3261e; --success: #16a34a; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-color); margin: 0; display: flex; flex-direction: column; min-height: 100vh; }
        nav { padding: 1rem 3rem; border-bottom: 1px solid var(--border); background: #fff; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-family: 'Playfair Display', serif; font-size: 1.2rem; font-weight: 600; }
        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; padding: 2rem; max-width: 1400px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        .panel { background: #fff; border: 1px solid var(--border); border-radius: 12px; padding: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.02); }
        .log-box { background: #1e1e1e; color: #a3a3a3; font-family: monospace; padding: 1rem; height: 350px; overflow-y: auto; border-radius: 8px; font-size: 0.8rem; line-height: 1.5; }
        .participant-row { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border); background: #faf9f7; border-radius: 8px; margin-bottom: 0.5rem; }
        button { padding: 0.6rem 1rem; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; transition: 0.2s; }
        .btn-primary { background: var(--text-color); color: #fff; }
        .btn-success { background: var(--success); color: #fff; }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: #666; }
        input { padding: 0.8rem; border: 1px solid var(--border); border-radius: 6px; width: 100%; box-sizing: border-box; margin-bottom: 1rem; }
        #init-state { max-width: 600px; margin: 5rem auto; text-align: center; }
        #active-state { display: none; }
        .queue-badge { font-size: 0.65rem; background: var(--text-color); color: #fff; padding: 2px 6px; border-radius: 4px; vertical-align: middle; margin-left: 0.5rem; }
    </style>
</head>
<body>
    <nav>
        <div class="logo">SmartST Executive Host</div>
        <div style="display: flex; gap: 1rem;">
            <button class="btn-outline" id="tvBtn" style="display: none;" onclick="launchTV()">TV View</button>
            <button class="btn-outline" onclick="handleLogout()">Logout</button>
        </div>
    </nav>

    <div class="container">
        <div id="init-state" class="panel" style="grid-column: span 2;">
            <h2>Initialize Framework</h2>
            <input type="text" id="initTheme" placeholder="Resolution / Theme">
            <input type="number" id="baseTimer" placeholder="Default Speaker Timer (Min)" value="5">
            <button class="btn-primary" style="width: 100%;" onclick="generateSession()">Deploy Secure Environment</button>
        </div>

        <div id="active-state" style="display: none; grid-column: span 2; display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div class="panel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h3>Roster & Parole Control</h3>
                    <div id="codeDisplay" style="font-weight: bold; letter-spacing: 2px;">CODE: ------</div>
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <label style="font-size: 0.75rem; text-transform: uppercase; color: #888;">Override Parole Duration (Min)</label>
                    <input type="number" id="manualTimer" placeholder="Minutes" style="margin-top: 0.5rem;">
                    <button class="btn-danger" style="width: 100%;" onclick="revokeFloor()">Halt Current Speaker</button>
                </div>
                <div id="participantList"></div>
            </div>

            <div class="panel">
                <h3>Executive Audit Log</h3>
                <div class="log-box" id="fullLog"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, collection, onSnapshot, arrayRemove } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyC9TyyYR3_rIzi7lNt4mRwTiinefy1YQn0", authDomain: "smartst-debate.firebaseapp.com", projectId: "smartst-debate", storageBucket: "smartst-debate.firebasestorage.app", messagingSenderId: "128238171772", appId: "1:128238171772:web:c08fe0c458ed7d9630fbf9" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let sessionCode = null, pData = {}, currentQueue = [];

        onAuthStateChanged(auth, (user) => { if (!user) window.location.href = "auth.html"; });
        window.handleLogout = () => signOut(auth).then(() => window.location.href = "index.html");
        window.launchTV = () => window.open(`tv.html?code=${sessionCode}`, 'Projector', 'width=1280,height=720');

        function appendLog(action) {
            const time = new Date().toLocaleTimeString();
            const log = document.getElementById('fullLog');
            log.innerHTML = `<div><span style="color:#818cf8">[${time}]</span> <strong>${action}</strong></div>` + log.innerHTML;
        }

        window.generateSession = async () => {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = ''; for (let i = 0; i < 6; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
            sessionCode = code;
            await setDoc(doc(db, "debates", sessionCode), {
                theme: document.getElementById('initTheme').value || "General Debate",
                queue: [], activeSpeakerId: null, activeSpeakerName: "Floor Open", activeTeam: "--", activeSide: "--", isTimerRunning: false, endTimeMs: null
            });
            document.getElementById('init-state').style.display = 'none';
            document.getElementById('active-state').style.display = 'grid';
            document.getElementById('tvBtn').style.display = 'block';
            document.getElementById('codeDisplay').innerText = `CODE: ${code}`;
            appendLog(`SESSION INITIALIZED: ${code}`);
            initSync();
        };

        function initSync() {
            onSnapshot(doc(db, "debates", sessionCode), (s) => {
                if(s.exists()){
                    currentQueue = s.data().queue || [];
                    renderRoster();
                }
            });
            onSnapshot(collection(db, "debates", sessionCode, "participants"), (s) => {
                s.forEach(d => pData[d.id] = d.data());
                renderRoster();
            });
        }

        function renderRoster() {
            const div = document.getElementById('participantList'); div.innerHTML = '';
            let rendered = new Set();
            currentQueue.forEach((pid, idx) => {
                if(pData[pid]){
                    div.appendChild(createRow(pid, pData[pid], idx + 1));
                    rendered.add(pid);
                }
            });
            for (let pid in pData) {
                if (!renderedIds.has(pid)) div.appendChild(createRow(pid, pData[pid], null));
            }
        }

        function createRow(pid, data, qPos) {
            const row = document.createElement('div'); row.className = 'participant-row';
            let badge = qPos ? `<span class="queue-badge">Q#${qPos}</span>` : '';
            row.innerHTML = `
                <div><strong>${data.name}${badge}</strong><br><small>${data.side} | ${data.team || '--'}</small></div>
                <div style="display:flex; gap:0.5rem;">
                    <button class="btn-success" onclick="grantParole('${pid}')">Grant</button>
                    <button class="btn-danger" onclick="issueWarn('${pid}')">Warn</button>
                    <button class="btn-outline" onclick="clearWarn('${pid}')">Clear</button>
                </div>`;
            return row;
        }

        window.grantParole = async (pid) => {
            try {
                const p = pData[pid];
                const mins = parseInt(document.getElementById('manualTimer').value) || parseInt(document.getElementById('baseTimer').value) || 5;
                await updateDoc(doc(db, "debates", sessionCode), {
                    activeSpeakerId: pid,
                    activeSpeakerName: p.name || "Unknown",
                    activeTeam: p.team || "--",
                    activeSide: p.side || "--",
                    endTimeMs: Date.now() + (mins * 60000),
                    isTimerRunning: true,
                    queue: arrayRemove(pid)
                });
                appendLog(`PAROLE GRANTED: ${p.name} (${mins}m)`);
            } catch (err) { alert("Grant Error: " + err.message); }
        };

        window.revokeFloor = async () => {
            await updateDoc(doc(db, "debates", sessionCode), { isTimerRunning: false, activeSpeakerId: null, activeSpeakerName: "Floor Open", activeTeam: "--", activeSide: "--" });
            appendLog("FLOOR REVOKED BY HOST");
        };

        window.issueWarn = async (pid) => {
            const m = prompt("Warning Directive:");
            if(m) {
                await updateDoc(doc(db, "debates", sessionCode, "participants", pid), { warning: m });
                appendLog(`WARNING: ${pData[pid].name} - ${m}`);
            }
        };

        window.clearWarn = async (pid) => {
            await updateDoc(doc(db, "debates", sessionCode, "participants", pid), { warning: "" });
            appendLog(`CLEAR: Warning removed for ${pData[pid].name}`);
        };
    </script>
</body>
</html>
