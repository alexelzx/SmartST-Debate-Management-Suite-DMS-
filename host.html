<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SmartST - Executive Host</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600&family=Inter:wght@400;600&display=swap');
        :root { --bg-color: #F4F2ED; --text-color: #1C1C1C; --border: rgba(0,0,0,0.1); --danger: #b3261e; --success: #16a34a; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-color); margin: 0; display: flex; flex-direction: column; min-height: 100vh; }
        nav { padding: 1rem 3rem; border-bottom: 1px solid var(--border); background: #fff; display: flex; justify-content: space-between; align-items: center; }
        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; padding: 2rem; max-width: 1400px; margin: 0 auto; width: 100%; }
        .panel { background: #fff; border: 1px solid var(--border); border-radius: 12px; padding: 2rem; }
        .log-box { background: #1e1e1e; color: #a3a3a3; font-family: monospace; padding: 1rem; height: 300px; overflow-y: auto; border-radius: 8px; font-size: 0.8rem; }
        .participant-row { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border); }
        button { padding: 0.6rem 1rem; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; }
        .btn-grant { background: var(--success); color: #fff; }
        .btn-warn { background: var(--danger); color: #fff; }
        .btn-clear { background: #666; color: #fff; }
    </style>
</head>
<body>
    <nav><div style="font-family:'Playfair Display',serif; font-weight:600;">SmartST Host</div><div id="sessionCodeDisplay">---</div></nav>
    <div class="container">
        <div class="panel">
            <h3>Roster & Parole Control</h3>
            <div id="participantList"></div>
        </div>
        <div class="panel">
            <h3>Executive Audit Log</h3>
            <div class="log-box" id="fullLog"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, collection, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyC9TyyYR3_rIzi7lNt4mRwTiinefy1YQn0", authDomain: "smartst-debate.firebaseapp.com", projectId: "smartst-debate", storageBucket: "smartst-debate.firebasestorage.app", messagingSenderId: "128238171772", appId: "1:128238171772:web:c08fe0c458ed7d9630fbf9" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const urlParams = new URLSearchParams(window.location.search);
        const sessionCode = urlParams.get('code');
        let participants = {};

        if(sessionCode) {
            document.getElementById('sessionCodeDisplay').innerText = `Session: ${sessionCode}`;
            initSync();
        }

        function appendLog(action) {
            const time = new Date().toLocaleTimeString();
            const log = document.getElementById('fullLog');
            log.innerHTML = `<div>[${time}] ${action}</div>` + log.innerHTML;
        }

        function initSync() {
            onSnapshot(collection(db, "debates", sessionCode, "participants"), (snap) => {
                const list = document.getElementById('participantList');
                list.innerHTML = '';
                snap.forEach(d => {
                    const data = d.data(); participants[d.id] = data;
                    list.innerHTML += `
                        <div class="participant-row">
                            <div><strong>${data.name}</strong><br><small>${data.side}</small></div>
                            <div>
                                <button class="btn-grant" onclick="grantParole('${d.id}')">Grant</button>
                                <button class="btn-warn" onclick="issueWarn('${d.id}')">Warn</button>
                                <button class="btn-clear" onclick="clearWarn('${d.id}')">Clear</button>
                            </div>
                        </div>`;
                });
            });
        }

        window.grantParole = async (pid) => {
            const p = participants[pid];
            await updateDoc(doc(db, "debates", sessionCode), {
                activeSpeakerId: pid, activeSpeakerName: p.name, activeSide: p.side,
                isTimerRunning: true, endTimeMs: Date.now() + 300000, queue: arrayRemove(pid)
            });
            await updateDoc(doc(db, "debates", sessionCode, "participants", pid), { history: arrayUnion(`Parole granted at ${new Date().toLocaleTimeString()}`) });
            appendLog(`PAROLE GRANTED: ${p.name}`);
        };

        window.issueWarn = async (pid) => {
            const msg = prompt("Warning directive:");
            if(msg) {
                await updateDoc(doc(db, "debates", sessionCode, "participants", pid), { warning: msg, history: arrayUnion(`Warned: ${msg}`) });
                appendLog(`WARNING ISSUED: ${participants[pid].name} - ${msg}`);
            }
        };

        window.clearWarn = async (pid) => {
            await updateDoc(doc(db, "debates", sessionCode, "participants", pid), { warning: "" });
            appendLog(`WARNING CLEARED: ${participants[pid].name}`);
        };
    </script>
</body>
</html>
